
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Generating Preloaded Sqlite Data - My little Android warehouse</title>
  <meta name="author" content="Federico Paolinelli">

  
  <meta name="description" content="Preloading data in Sqlite is a common problem during android development.The most common solutions are:hardcode the insert statements and execute &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://fedepaol.github.io/blog/2014/04/08/preloading-localized-data-in-sqllte">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My little Android warehouse" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16514009-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My little Android warehouse</a></h1>
  
    <h2>Random thoughts about my experience as moonlight android developer.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:fedepaol.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Generating Preloaded Sqlite Data</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-08'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><div class='post'>
Preloading data in Sqlite is a common problem during android development.<br />The most common solutions are:<br /><ul><li>hardcode the insert statements and execute them (possibly inside a transaction) the first time the db is opened</li><li>place the data inside a csv file, load it the first time the db gets opened, parse the rows and populate the db</li><li>prepare a pre-built sqlite file, ship it along with your app and load it the first time the db is opened</li></ul><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/CmGdiFU.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/CmGdiFU.jpg" height="320" width="320" /></a></div><br /><ul></ul>I'll focus on the third approach, because it allows us to check our db outside the app without extracting it from our device, and because it allows us to prepare the data in a more "human friendly way".<br /><br />It's worth to mention the excellent <a href="https://github.com/jgilfelt/android-sqlite-asset-helper">sqlite asset helper</a> library by Jeff Gifelt, that allows us to embed a prebuilt (compressed) sqlite file without having to reinvent the wheel. For this reason, this post will be about how to handle data entry process (and something more), and you won't find a (yet another) way to preload a sqlite file.<br /><br />Let's start with a problem: you want to build a pretty simple <a href="https://play.google.com/store/apps/details?id=com.whiterabbit.freshfruitveg">Seasonal Fruit and Vegetables</a> app, and the amount of data you have to deal with is big enough to discourage you to prepare the inserts manually.<br />You'll have:<br /><ul><li>the list of products</li><li>the description of each product (possibly localized in different languages)</li><li>the data related to the seasonality of each product</li></ul>So, here's the approach:<br /><h3>Step 1: data entry </h3>Use a spreadsheet to fill the data in a human friendly way, export it as csv (or tsv, so you won't have to deal with any random comma inside the descriptions), parse it and produce the sqlite file together with localized string res files to be embedded inside the application.<br />In my case I had a file&nbsp; having the genre (fruit or veg), the calories count, the name and the description in italian and in english:<br /><br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> asparagus     0     25     Asparagi     Descrizione asparagi in italiano.      Asparagus     English asparagus description  <br /> chard          0     12     Bietola          Descrizione bietola in italiano.      Chard          English chard description  <br /></code></pre><br /><br />I also have files that describe the seasonality of each products in different areas, but I will not describe them since they are not relevant to the approach I am describing here.<br /><br /><h3>Step 2: Parse!</h3>Choose your favorite scripting language. I went for python since it's super slick and it comes with batteries included, such as xml writing and sqllite support.<br /><br />Creating the db is straightforward:<br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> CREATE_ITEMS = 'create table Item (_id integer primary key, Name text, kind integer, calories integer);'  <br /> CREATE_ITEM_PER_MONTHS = 'create table ItemPerMonth (ItemId integer, Month integer, Freshness integer, Area integer);'  <br /> CREATE_ITEM_PREFERRED = 'create table PreferredItem (PreferredItemId integer);'  <br /> conn = sqlite3.connect('fruit')  <br /> c = conn.cursor()  <br /> c.execute(CREATE_ITEM_PER_MONTHS)  <br /> c.execute(CREATE_ITEM_PREFERRED)  <br /></code></pre><br /><br />Then we need to use the data we have to fullfill two purpouses:<br /><ul><li>fill the database</li><li>fill the localized string resources&nbsp;</li></ul>Again, filling the database consists of parsing each line of the csv file and calling the appropriate insert.<br /><br />In python is as easy as calling<br /><br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">   cursor.execute(statement)  <br /></code></pre><br />on a cursor object, where statement is the insert statement.<br /><br />Together with that, we do have a lot of data that needs to be rendered in the proper language.<br />In order to take advantage of the resource framework, I chose to generate the resource files instead of relying on a "locale" field in the db to filter in my queries.<br />Again, filling an xml node is pretty straightforward in python:<br /><br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">   name = ET.SubElement(root, "string")  <br />   name.set("name", item_name)  <br />   if lang_name.find('%') != -1:  <br />     name.set("formatted", "false")  <br />   name.text = lang_name  <br /></code></pre><br /><br />At this point, we can generate an it_descriptions.xml file and an eng_descriptions.xml file (and even let our script place them in the proper folders).<br /><br />When we want to use our descriptions in Android (i.e. in&nbsp; our cursor adapter's bindView), we&nbsp; need to bind the product name (i.e. "asparagus") with the corresponding resource. That's easy and it can be done in this way:<br /><br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">  int nameResID = context.getResources().getIdentifier(name,   <br />                     "string", context.getPackageName());  <br /></code></pre><br />By doing that, we can retrieve the resource id of the string related to the name that was generated by our script. If we are worried about the cost of the lookup, we can even add a lru cache to absorb that cost.<br /><br /><br />TL;DR:<br /><ul><li>Write your data in a human readable format</li><li>Parse that data with your favourite language</li><li>Write the data that does not depends on the language in sqllite</li><li>Write the language-dependent data in resource files</li><li>Use getIdentifier for retrieving the resource id of the strings automatically generated</li></ul>Bonus point: again, you can use this convention for pictures as well, so you can throw an "asparagus.png" image in your assets to be loaded afterwards.<br /><br />The biggest advantage of this approach is that you have only one master source of your data (the spreadsheet) that you can modify and rerun the generator over every time you modify it. <br /><br />If you are interested in the whole loader python script you can <a href="https://gist.github.com/fedepaol/10193052">check it here</a><br /><br /><br /><br /><br /></div>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Federico Paolinelli</span></span>

      




<time class='entry-date' datetime='2014-04-08'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android-sqlite/'>android sqlite</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://fedepaol.github.io/blog/2014/04/08/preloading-localized-data-in-sqllte/" data-via="fedepaol" data-counturl="http://fedepaol.github.io/blog/2014/04/08/preloading-localized-data-in-sqllte/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/02/20/rest-interaction-in-android/" title="Previous Post: Rest interaction in Android ">&laquo; Rest interaction in Android </a>
      
      
        <a class="basic-alignment right" href="/blog/2014/08/24/migrating-from-blogger-to-octopress-done/" title="Next Post: Migrating from blogger to octopress (done!)">Migrating from blogger to octopress (done!) &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Lead developer with electronic trading software by day, passionate about mobile. I spend a lot of my spare time writing software for android. Table Tennis player, snowboarder, dad. I also contribute to Firefox for Android.</p>
  <a href="mailto:fedepaol@gmail.com" target="_top">fedepaol@gmail.com</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/06/20/how-to-a-timer/">Reactive Android Timers, Countdowns and Lifecycle</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/20/happines-is-relative/">Happiness Is (a) Relative (Layout)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/01/cached-rest-requests-with-rxjava/">Subscribe It While It's Hot: Cached Rest Requests With RxJava</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/13/testing-rxjava-observables-subscriptions/">Unit Testing RxJava Observables and Subscriptions</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/05/mocking-with-robolectric-and-dagger-2/">Mocking With Robolectric and Dagger 2</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/fedepaol">@fedepaol</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'fedepaol',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+FedericoPaolinelli?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
	<h1>On Twitter:</h1>
	<div>
		<p><br /><a href="http://twitter.com/fedepaol" target="_blank">My Tweets, on Twitter.</a></p>
		<a href="http://twitter.com/fedepaol" class="twitter-follow-button" data-show-count="">Follow @fedepaol</a>
	</div>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Federico Paolinelli -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
