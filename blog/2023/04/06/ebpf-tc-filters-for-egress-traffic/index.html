<!DOCTYPE html>
<html lang="en-us">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">




<title>EBPF TC filters for egress traffic | My little software warehouse</title>

<link rel="stylesheet" href="https://fedepaol.github.io//css/styles.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" 
integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/zenburn.min.css" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="https://fedepaol.github.io//js/highlight.js"></script>






<div class="container">
    <nav class="navbar level">
      <div class="navbar-brand">
          <a class="nav-item" href="https://fedepaol.github.io/"><h1 class="title is-3">My little software warehouse</h1></a>
      </div>           
      <div class="navbar-menu has-text-centered is-active">
          <div class="navbar-end is-centered">
              
                <a href="https://twitter.com/fedepaol" rel="me">
                  <span class="icon">
                    <i class="fab fa-twitter"></i>
                  </span>
                </a>
              
                <a href="https://fedepaol.github.io/about" rel="me">
                  <span class="icon">
                    <i class="fas fa-info"></i>
                  </span>
                </a>
              
                <a href="https://github.com/fedepaol" rel="me">
                  <span class="icon">
                    <i class="fab fa-github"></i>
                  </span>
                </a>
              
                <a href="https://linkedin.com/in/federico-paolinelli-2374954/" rel="me">
                  <span class="icon">
                    <i class="fab fa-linkedin-in"></i>
                  </span>
                </a>
              
           </div>
      </div>
    </nav>
  </div>

<div class="container">
  <h2 class="subtitle is-6">April 6, 2023</h2>
  <h1 class="subtitle is-size-4-mobile is-size-3-desktop">EBPF TC filters for egress traffic</h1>
  <div class="content">
    <h1 id="network-filters-with-ebpf-and-tc">Network filters with EBPF and TC</h1>
<p>EBPF has been on my radar for a while, and given my involvement with MetalLB, starting from a network hook felt natural.</p>
<p>So, I started with a very simple idea in mind: writing a hook that drives the egress traffic to a different next hop, based on some criteria. This comes from a real problem
that a few MetalLB users raised: we have an asymmetric return path when the traffic comes to the node via a secondary (i.e. non default gateway) interface and the client is
multiple hops away (and we don&rsquo;t have a routing strategy on the host).</p>
<p><img src="/images/tcegress/scheme.png" alt=""></p>
<p>One possible solution (also implemented by the <a href="https://github.com/travisghansen/metallb-node-route-agent">metallb node route agent</a>) is to use strategies like source based routing (or marking based) to get the traffic exit via the right interface, but hey
EBPF is <em>a la mode</em>, so why not to try to use it?</p>
<h2 id="first-hurdles">First hurdles</h2>
<p>I really struggled to find the right documentation. XDP is well documented, it has an excellent tutorial which I tried to follow, and there&rsquo;s a nice example on how to
run an xdp hook from go.</p>
<p>But the problem is, XDP works only for ingress.
On the other side, TC is well known to <em>control traffic</em> with classes, queuing disciplines and filters, but it&rsquo;s relationship with ebpf wasn&rsquo;t totally clear to me.</p>
<p>The best source of information for how the tc / ebpf machinery work is <a href="https://qmonnet.github.io/whirl-offload/2020/04/11/tc-bpf-direct-action/">this blogpost by Quentin Monnet</a>, where he demistifies the <code>direct-action</code> and the <code>clsact</code> qdiscs and how they allow the action itself to be embedded in the filters
implemented as ebpf programs, instead of having the action listed in the filter declaration.</p>
<h2 id="just-give-me-some-code-to-copy">Just give me some code to copy!</h2>
<p>This is by far the biggest issue I had. I wasn&rsquo;t able to find a proper example on how to create such filter and how to load it from Go, and such example was
lacking from the <a href="https://github.com/cilium/ebpf/tree/master/examples">cilium ebpf library examples</a>.</p>
<p>Anyway, after digging into issues and discussions <a href="https://github.com/cilium/ebpf/issues/768">1</a>,<a href="https://github.com/cilium/ebpf/discussions/769">2</a>, <a href="https://github.com/florianl/tc-skeleton/discussions/2">3</a>, and also by <del>ruthless copying</del> taking inspiration from the cilium codebase, I was able to put together the right enchantment
to load an ebpf filter via TC.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#a6e22e">devID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">InterfaceByName</span>(<span style="color:#e6db74">&#34;eth0&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;could not get interface ID: %w&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">qdisc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">GenericQdisc</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">QdiscAttrs</span>: <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">QdiscAttrs</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">LinkIndex</span>: <span style="color:#a6e22e">devID</span>.<span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Handle</span>:    <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">MakeHandle</span>(<span style="color:#ae81ff">0xffff</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Parent</span>:    <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">HANDLE_CLSACT</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">QdiscType</span>: <span style="color:#e6db74">&#34;clsact&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">QdiscReplace</span>(<span style="color:#a6e22e">qdisc</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;could not get replace qdisc: %w&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">filter</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">BpfFilter</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">FilterAttrs</span>: <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">FilterAttrs</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">LinkIndex</span>: <span style="color:#a6e22e">devID</span>.<span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Parent</span>:    <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">HANDLE_MIN_EGRESS</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Handle</span>:    <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Protocol</span>:  <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">ETH_P_ALL</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Fd</span>:           <span style="color:#a6e22e">program</span>.<span style="color:#a6e22e">FD</span>(),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Name</span>:         <span style="color:#a6e22e">program</span>.<span style="color:#a6e22e">String</span>(),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DirectAction</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">netlink</span>.<span style="color:#a6e22e">FilterReplace</span>(<span style="color:#a6e22e">filter</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to replace tc filter: %w&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>Both the <code>handle</code> and the <code>parent</code> ids passed to the qdisc and to the filter are taken with a leap of faith from the tc implementation itself <a href="https://github.com/shemminger/iproute2/blob/main/tc/tc_qdisc.c#L92">1</a>, <a href="https://github.com/shemminger/iproute2/blob/main/tc/tc_filter.c#L118">2</a>.</p>
<p>The full example including a docker-compose for validation is available on github at <a href="https://github.com/fedepaol/tc-return">github.com/fedepaol/tc-return</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>I hope this blogpost will help people looking on how to use EBPF to steer egress traffic via tc to save some time. Ebpf is a powerful tool, but sometimes the information
on how to use it properly is scattered across different sources.</p>

  </div>
</div>
<div class="container has-text-centered">
    
</div>

<div class="container has-text-centered">
  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      (function() {
          
          
          if (window.location.hostname == "localhost")
              return;
      
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          var disqus_shortname = 'fedepaolgithubio';
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  
</div>
<section class="section">
  <div class="container has-text-centered">
    <p></p>
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-16514009-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



